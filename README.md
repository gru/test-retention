
# Kafka Retention Test Stand

–≠—Ç–æ—Ç —Å—Ç–µ–Ω–¥ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è Apache Kafka –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ **retention.bytes**, —Ç–æ –µ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ª–æ–≥–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ç–æ–ø–∏–∫–∞ ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ consumer –µ—â—ë –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–ª —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.

## üìÅ –°–æ—Å—Ç–∞–≤ —Ñ–∞–π–ª–æ–≤

### docker-compose.yaml
–ü–æ–¥–Ω–∏–º–∞–µ—Ç Kafka –∏ Zookeeper. –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

- `KAFKA_LOG_RETENTION_BYTES = 1048576` (1 –ú–ë)
- `KAFKA_LOG_SEGMENT_BYTES = 1048576` (1 –ú–ë —Å–µ–≥–º–µ–Ω—Ç—ã)
- `KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS = 5000`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –≤–∫–ª—é—á–µ–Ω–æ —á–µ—Ä–µ–∑:
  ```
  KAFKA_LOG4J_LOGGERS="kafka.log.LogCleaner:DEBUG,kafka.log.Log:DEBUG"
  KAFKA_LOG4J_ROOT_LOGLEVEL=INFO
  ```

### create-topic.sh
–°–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–ø–∏–∫ test-ret-bytes.

### produce-messages.sh
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞–Ω–Ω—ã–π –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ Kafka.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```
./produce-messages.sh <MB> <topic>
```

### consume-messages.sh
–ß–∏—Ç–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ç–æ–ø–∏–∫–∞ –∏ –≤—ã–≤–æ–¥–∏—Ç:
- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- –æ–±—â–∏–π –æ–±—ä—ë–º –≤ –±–∞–π—Ç–∞—Ö
- –æ–±—ä—ë–º –≤ –ú–ë
```
./consume-messages.sh <topic> [messages_per_second] [broker]
```
–≥–¥–µ
- `messages_per_second = -1` ‚Äî —á–∏—Ç–∞—Ç—å –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ (—Ä–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ —á–∏—Å–ª–æ N ‚Äî consumer —á–∏—Ç–∞–µ—Ç N —Å–æ–æ–±—â–µ–Ω–∏–π, –∑–∞—Ç–µ–º –¥–µ–ª–∞–µ—Ç `sleep 1`  

### grep-kafka-logs.sh
–§–∏–ª—å—Ç—Ä—É–µ—Ç –≤—ã–≤–æ–¥ `docker logs` –ø–æ —Å—Ç—Ä–æ–∫–∞–º:
```
./grep-kafka-logs.sh "Deleted"
```

### reset-kafka.sh
–û—á–∏—â–∞–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã + volumes).

---

## üß™ –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∞ ‚Ññ1

### 1. –°–±—Ä–æ—Å–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ
```
./reset-kafka.sh
docker compose up -d
```

### 2. –°–æ–∑–¥–∞—Ç—å —Ç–æ–ø–∏–∫
```
./create-topic.sh
```

### 3. –ó–∞–ø–∏—Å–∞—Ç—å 10 –ú–ë –¥–∞–Ω–Ω—ã—Ö
```
./produce-messages.sh 10 test-ret-bytes
```

### 4. –î–æ–∂–¥–∞—Ç—å—Å—è —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
```
./grep-kafka-logs.sh "Deleted"
```

–û–∂–∏–¥–∞–µ–º—ã–µ —Å—Ç—Ä–æ–∫–∏:
```
Deleted log ... .log.deleted
Deleted offset index ...
Deleted snapshot ...
```

### 5. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–æ–ø–∏–∫–∞
```
./consume-messages.sh test-ret-bytes
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –ü—Ä–æ—á–∏—Ç–∞–Ω–æ ~1 –ú–ë –¥–∞–Ω–Ω—ã—Ö
- –û—Å—Ç–∞–ª—å–Ω–æ–µ Kafka —É–¥–∞–ª–∏–ª–∞

---

## üß™ –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∞ ‚Ññ2


### 1. –°–±—Ä–æ—Å–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ
```
./reset-kafka.sh
docker compose up -d
```

### 2. –°–æ–∑–¥–∞—Ç—å —Ç–æ–ø–∏–∫
```
./create-topic.sh
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å consumer –≤ —Ä–µ–∂–∏–º–µ —á—Ç–µ–Ω–∏—è –ø–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
```
./consume-messages.sh test-ret-bytes 100
```

### 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å producer –∑–∞–ø–∏—Å–∞–≤ –æ–∫–æ–ª–æ 15–ú–ë –¥–∞–Ω–Ω—ã—Ö
```
./produce-messages.sh 20 test-ret-bytes
```

### 5. Consumer –Ω–∞—á–Ω–µ—Ç —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
–ù–∞ —á—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –µ–º—É –¥–æ–ª–∂–Ω–æ –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —á—É—Ç—å –±–æ–ª—å—à–µ 2 –º–∏–Ω—É—Ç. 
–í–∏–¥–∏–º —á—Ç–æ consumer –ø—Ä–æ—á–∏—Ç–∞–ª –æ–∫–æ–ª–æ 9 –ú–ë –¥–∞–Ω–Ω—ã—Ö.
```
Messages consumed: 9230
Total bytes consumed: 9460750 bytes
Total size: 9,02 MB
```

### 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–µ kafka
```
./grep-kafka-logs.sh "Deleted"
```

–û–∂–∏–¥–∞–µ–º—ã–µ —Å—Ç—Ä–æ–∫–∏:
```
Deleted log ... .log.deleted
Deleted offset index ...
Deleted snapshot ...
```

## üéØ –ò—Ç–æ–≥

Kafka —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –±—ã–ª–∏ –ª–∏ –æ–Ω–∏ –ø—Ä–æ—á–∏—Ç–∞–Ω—ã**, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω `retention.bytes`.

